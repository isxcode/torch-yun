## 后端开发规范

#### 修改版本号

[VERSION](VERSION)

```wikitext
GH-275
```

要求
- 开发者第一时间，修改版本号
- 版本号格式为 GH-xxx，与github中的issue号保持一致
- AI禁止修改此文件

#### 创建模块定语

- [ModuleCode.java](torch-yun-backend/torch-yun-api/src/main/java/com/isxcode/torch/api/main/constants/ModuleCode.java)

```java
/**
 * 模型广场.
 */
String MODEL_PLAZA = "/model/plaza";
```

要求：
- CODE为全部大写，`_`分割符号，英文直译易懂

#### 数据库脚本变动

- [V7__GH-275.sql](torch-yun-backend/torch-yun-main/src/main/resources/db/migration/h2/V7__GH-275.sql)

```sql
-- 模型广场
create table if not exists TY_MODEL_PLAZA
(
    id                      varchar(200)  not null unique primary key comment '模型id',
    org_name                varchar(200)  not null comment '组织名称',
    model_name              varchar(200)  not null comment '模型名称',
    is_online               varchar(200)  not null comment '在线模型 ENABLE,离线模型 DISABLE',
    label                   varchar(200)  not null comment '类别多模态等',
    model_type              varchar(500)  not null comment '语音/文本',
    model_param             varchar(200)  null comment '模型参数',
    remark                  varchar(200)  null comment '模型描述',
    create_by               varchar(200)  not null comment '创建人',
    create_date_time        datetime      not null comment '创建时间',
    last_modified_by        varchar(200)  not null comment '更新人',
    last_modified_date_time datetime      not null comment '更新时间',
    deleted                 int default 0 not null comment '逻辑删除',
    version_number          int           not null comment '版本号'
);

INSERT INTO PUBLIC.TY_MODEL_PLAZA (ID, ORG_NAME, MODEL_NAME, IS_ONLINE, LABEL, MODEL_TYPE, MODEL_PARAM, REMARK,
                                   CREATE_BY, CREATE_DATE_TIME, LAST_MODIFIED_BY, LAST_MODIFIED_DATE_TIME, DELETED,
                                   VERSION_NUMBER)
VALUES ('Aliyun_qwen3-max', 'Aliyun', 'qwen3-max', 'ENABLE', 'Natural Language Processing', 'Text Generation', '235B',
        '通义千问3系列Max模型，相较preview版本在智能体编程与工具调用方向进行了专项升级。本次发布的正式版模型达到领域SOTA水平，适配场景更加复杂的智能体需求。',
        'admin', '2025-12-18 16:17:19.000000', 'admin', '2025-12-18 16:17:23.000000', 0, 0);
```

要求：
- 基于flyway开发项目
- 文件名规范：V[序号]__[VERSION].sql
- 建表为`TY_开`头，为torch-yun缩写

#### 创建业务代码模块文件夹

- [plaza](torch-yun-backend/torch-yun-modules/src/main/java/com/isxcode/torch/modules/model/plaza)

要求：
- 根据模块定语创建文件夹 `model/plaza`
- 模块下需要创建文件夹
1. controller: 定义接口
2. entity: 实体类与数据库中表一一对应
3. mapper: 对象转换层
4. repository: 数据库交互层
5. service: 通用服务器层，通用层之间禁止互相调用
6. service/biz: 业务服务实现层

##### Entity

- [ModelPlazaEntity.java](torch-yun-backend/torch-yun-modules/src/main/java/com/isxcode/torch/modules/model/plaza/entity/ModelPlazaEntity.java)

```java
package com.isxcode.torch.modules.model.plaza.entity;

@Data
@Entity
@SQLDelete(sql = "UPDATE TY_MODEL_PLAZA SET deleted = 1 WHERE id = ? and version_number = ?")
@Where(clause = "deleted = 0")
@Table(name = "TY_MODEL_PLAZA")
@JsonIgnoreProperties({"hibernateLazyInitializer"})
@EntityListeners(AuditingEntityListener.class)
public class ModelPlazaEntity {

    @Id
    @GeneratedValue(generator = "sy-id-generator")
    @GenericGenerator(name = "sy-id-generator", strategy = "com.isxcode.torch.config.GeneratedValueConfig")
    private String id;

    private String orgName;

    private String modelName;

    private String isOnline;

    private String label;

    private String modelType;

    private String modelParam;

    private String remark;

    @CreatedDate
    private LocalDateTime createDateTime;

    @LastModifiedDate
    private LocalDateTime lastModifiedDateTime;

    @CreatedBy
    private String createBy;

    @LastModifiedBy
    private String lastModifiedBy;

    @Version
    private Long versionNumber;

    @Transient
    private Integer deleted;
}
```

##### Repository

[ModelPlazaRepository.java](torch-yun-backend/torch-yun-modules/src/main/java/com/isxcode/torch/modules/model/plaza/repository/ModelPlazaRepository.java)

```java
package com.isxcode.torch.modules.model.plaza.repository;

@Repository
@CacheConfig(cacheNames = {ModuleCode.MODEL_PLAZA})
public interface ModelPlazaRepository extends JpaRepository<ModelPlazaEntity, String> {

    @Query("SELECT M FROM ModelPlazaEntity M WHERE M.orgName LIKE %:keyword% OR M.modelName LIKE %:keyword% OR M.remark LIKE %:keyword% order by M.createDateTime desc ")
    Page<ModelPlazaEntity> searchAll(@Param("keyword") String searchKeyWord, Pageable pageable);
    
    @Query("SELECT A FROM AppEntity A WHERE (A.status = :appStatus or :appStatus is null ) and ( A.name LIKE %:keyword% OR A.remark LIKE %:keyword% OR A.name LIKE %:keyword% ) order by A.createDateTime desc ")
    Page<AppEntity> searchAll(@Param("keyword") String searchKeyWord, @Param("appStatus") String appStatus,
        Pageable pageable);
}
```

##### Mapper

[ModelPlazaMapper.java](torch-yun-backend/torch-yun-modules/src/main/java/com/isxcode/torch/modules/model/plaza/mapper/ModelPlazaMapper.java)

```java
package com.isxcode.torch.modules.model.plaza.mapper;

@Mapper(componentModel = "spring")
public interface ModelPlazaMapper {

    PageModelRes modelPlazaEntityToPageModelRes(ModelPlazaEntity modelPlazaEntity);
}

```

#### Service

[ModelPlazaService.java](torch-yun-backend/torch-yun-modules/src/main/java/com/isxcode/torch/modules/model/plaza/service/ModelPlazaService.java)

```java
package com.isxcode.torch.modules.model.plaza.service;

@Service
@Slf4j
@RequiredArgsConstructor
public class ModelPlazaService {

}
```

#### BizService

[ModePlazaBizService.java](torch-yun-backend/torch-yun-modules/src/main/java/com/isxcode/torch/modules/model/plaza/service/biz/ModePlazaBizService.java)

```java
package com.isxcode.torch.modules.model.plaza.service.biz;

@Service
@Slf4j
@RequiredArgsConstructor
@Transactional
public class ModePlazaBizService {
    private final ModelPlazaRepository modelPlazaRepository;

    private final ModelPlazaMapper modelPlazaMapper;

    public Page<PageModelRes> pageModel(PageModelReq pageModelReq) {

        Page<ModelPlazaEntity> modelPlazaPage = modelPlazaRepository.searchAll(pageModelReq.getSearchKeyWord(),
            PageRequest.of(pageModelReq.getPage(), pageModelReq.getPageSize()));

        return modelPlazaPage.map(modelPlazaMapper::modelPlazaEntityToPageModelRes);
    }
}

```

#### Api 

> 所有的java对象统一放在[torch-yun-api](torch-yun-backend/torch-yun-api)
> 创建目录
[plaza](torch-yun-backend/torch-yun-api/src/main/java/com/isxcode/torch/api/model/plaza)

- constant: 所有静态参数
- req: 所有请求对象
- res: 所有响应对象
- dto: 所有业务对象
- ao: 多表联查对象

##### Req

```java
package com.isxcode.torch.api.model.plaza.req;

@EqualsAndHashCode(callSuper = true)
@Data
public class PageModelReq extends BasePageRequest {

}
```

##### Res

```java
package com.isxcode.torch.api.model.plaza.res;

@Data
@JsonInclude(JsonInclude.Include.NON_NULL)
public class PageModelRes {

    private String id;

    private String orgName;

    private String modelName;

    private String isOnline;

    private String label;

    private String modelType;

    private String modelParam;

    private String remark;
}
```

#### Controller

[ModelPlazaController.java](torch-yun-backend/torch-yun-modules/src/main/java/com/isxcode/torch/modules/model/plaza/controller/ModelPlazaController.java)

```java
@Tag(name = "模型广场模块")
@RequestMapping(ModuleCode.MODEL_PLAZA)
@RestController
@RequiredArgsConstructor
public class ModelPlazaController {

    private final ModePlazaBizService modePlazaBizService;

    @Operation(summary = "查询模型仓库接口")
    @PostMapping("/pageModel")
    @SuccessResponse("查询成功")
    public Page<PageModelRes> pageModel(@Valid @RequestBody PageModelReq pageModelReq) {

        return modePlazaBizService.pageModel(pageModelReq);
    }
}
```